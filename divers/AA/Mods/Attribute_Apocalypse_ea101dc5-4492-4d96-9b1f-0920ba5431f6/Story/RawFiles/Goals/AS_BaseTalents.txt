Version 1
SubGoalCombiner SGC_AND
INITSECTION
DB_AS_DefaultTalents("AttackOfOpportunity");
DB_AS_DefaultTalents("QuickStep");
DB_AS_DefaultTalents("ViolentMagic");
KBSECTION
IF
GameStarted(_Level,_)
AND
IsCharacterCreationLevel(_Level,0)
THEN
TimerCancel("AS_REMOVEVIOLENTMAGIC");
TimerLaunch("AS_REMOVEVIOLENTMAGIC",1000);

IF
TimerFinished("AS_REMOVEVIOLENTMAGIC")
THEN
IterateParties("AS_RemoveBadTalents");

IF
StoryEvent((CHARACTERGUID)_Char,"AS_RemoveBadTalents")
AND
CharacterHasTalent(_Char,"ViolentMagic",1)
AND
CharacterIsInCombat(_Char,0)
THEN
CharacterRemoveTalent(_Char,"ViolentMagic");
SetStoryEvent(_Char,"AS_GiveTalentPoint");
//OpenMessageBox(_Char,"All characters begin combat with Savage Sortilege. You no longer need to spend a Talent Point for it.");
//CharacterAddTalentPoint(_Char,1);

IF
StoryEvent((CHARACTERGUID)_Char,"AS_RemoveBadTalents")
AND
CharacterHasTalent(_Char,"QuickStep",1)
AND
CharacterIsInCombat(_Char,0)
THEN
CharacterRemoveTalent(_Char,"QuickStep");
SetStoryEvent(_Char,"AS_GiveTalentPoint");
//OpenMessageBox(_Char,"All characters begin combat with The Pawn. You no longer need to spend a Talent Point for it.");
//CharacterAddTalentPoint(_Char,1);

IF
StoryEvent((CHARACTERGUID)_Char,"AS_RemoveBadTalents")
AND
CharacterHasTalent(_Char,"AttackOfOpportunity",1)
AND
CharacterIsInCombat(_Char,0)
THEN
CharacterRemoveTalent(_Char,"AttackOfOpportunity");
SetStoryEvent(_Char,"AS_GiveTalentPoint");
//OpenMessageBox(_Char,"All characters begin combat with Opportunist. You no longer need to spend a Talent Point for it.");
//CharacterAddTalentPoint(_Char,1);

/*
IF
CharacterUnlockedTalent(_Char,_Talent)
AND
DB_AS_DefaultTalents(_Talent)
THEN
TimerCancel("AS_REMOVEVIOLENTMAGIC");
TimerLaunch("AS_REMOVEVIOLENTMAGIC",1000);

IF
StoryEvent((CHARACTERGUID)_Char,"AS_GiveTalentPoint")
AND
ObjectGetFlag(_Char,"AS_BlacklistTalentPoint",0)
THEN
CharacterAddTalentPoint(_Char,1);
ObjectSetFlag(_Char,"AS_BlacklistTalentPoint");
ProcObjectTimerCancel(_Char,"AS_RemoveBlacklistTalentPoint");
ProcObjectTimer(_Char,"AS_RemoveBlacklistTalentPoint",700);
*/
/*
IF
CharacterUnlockedTalent((CHARACTERGUID)_Char,"ViolentMagic")
AND
CharacterIsInCombat(_Char,0)
AND
HasActiveStatus(_Char,"SUMMONING_ABILITY",0)
THEN
TimerCancel("AS_REMOVEVIOLENTMAGIC");
TimerLaunch("AS_REMOVEVIOLENTMAGIC",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Char,"AS_RemoveViolentMagic")
AND
CharacterHasTalent(_Char,"ViolentMagic",1)
AND
CharacterIsInCombat(_Char,0)
THEN
CharacterRemoveTalent(_Char,"ViolentMagic");
CharacterAddTalentPoint(_Char,1);
OpenMessageBox(_Char,"In DOS2:CE, all characters begin combat with Savage Sortilege. You no longer need to spend a Talent Point for it.");

IF
CharacterUnlockedTalent((CHARACTERGUID)_Char,"AttackOfOpportunity")
AND
CharacterIsInCombat(_Char,0)
AND
HasActiveStatus(_Char,"SUMMONING_ABILITY",0)
THEN
TimerCancel("AS_REMOVEVIOLENTMAGIC");
TimerLaunch("AS_REMOVEVIOLENTMAGIC",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Char,"AS_RemoveOpportunist")
AND
CharacterHasTalent(_Char,"AttackOfOpportunity",1)
AND
CharacterIsInCombat(_Char,0)
THEN
CharacterRemoveTalent(_Char,"AttackOfOpportunity");
CharacterAddTalentPoint(_Char,1);
OpenMessageBox(_Char,"In DOS2:CE, all characters begin combat with Opportunist. You no longer need to spend a Talent Point for it.");

IF
CharacterUnlockedTalent((CHARACTERGUID)_Char,"QuickStep")
AND
CharacterIsInCombat(_Char,0)
AND
HasActiveStatus(_Char,"SUMMONING_ABILITY",0)
THEN
TimerCancel("AS_REMOVEVIOLENTMAGIC");
TimerLaunch("AS_REMOVEVIOLENTMAGIC",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Char,"AS_RemoveQuickstep")
AND
CharacterHasTalent(_Char,"Quickstep",1)
AND
CharacterIsInCombat(_Char,0)
THEN
CharacterRemoveTalent(_Char,"QuickStep");
CharacterAddTalentPoint(_Char,1);
OpenMessageBox(_Char,"In DOS2:CE, all characters begin combat with The Pawn. You no longer need to spend a Talent Point for it.");
*/

IF
ItemEquipped(_,_Char)
THEN
ObjectSetFlag(_Char,"AS_Blacklist_TalentFromItem");
ProcObjectTimer(_Char,"AS_TalentItemBLReset",500);

IF
CharacterUnlockedTalent((CHARACTERGUID)_Char,_Talent)
AND
CharacterIsInCombat(_Char,0)
AND
IsTagged(_Char,"SUMMON",0)
AND
CharacterIsPlayer(_Char,1)
AND
ObjectGetFlag(_Char,"AS_Blacklist_DontRemoveTalents",0)
AND
ObjectGetFlag(_Char,"AS_Blacklist_TalentFromItem",0)
AND
DB_AS_DefaultTalents(_Talent)
THEN
DB_AS_BadTalent(_Char,_Talent);
ProcObjectTimer(_Char,"AS_RemoveBadTalent",10);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Char,"AS_RemoveBadTalent")
AND
DB_AS_BadTalent(_Char,_Talent)
AND
ObjectGetFlag(_Char,"AS_Blacklist_TalentFromItem",0)
THEN
CharacterRemoveTalent(_Char,_Talent);
CharacterAddTalentPoint(_Char,1);
OpenMessageBox(_Char,"Savage Sortilege, Opportunist and The Pawn are all innate talents during combat in Divine War. Your talent points for each have been refunded.");



PROC
ProcObjectTimerFinished(_Char,"AS_TalentItemBLReset")
THEN
ObjectClearFlag(_Char,"AS_Blacklist_TalentFromItem");

IF
CharacterUnlockedTalent((CHARACTERGUID)_Char,_Talent)
AND
CharacterIsInCombat(_Char,0)
AND
IsTagged(_Char,"SUMMON",0)
AND
CharacterIsPlayer(_Char,1)
AND
ObjectGetFlag(_Char,"AS_Blacklist_DontRemoveTalents",0)
AND
ObjectGetFlag(_Char,"AS_Blacklist_TalentFromItem",1)
AND
DB_AS_DefaultTalents(_Talent)
THEN
DB_AS_BaseTalentFromItem(_Char,_Talent);

IF
ItemUnEquipped(_,_Char)
AND
DB_AS_BaseTalentFromItem(_Char,_Talent)
THEN
ObjectSetFlag(_Char,"AS_Blacklist_TalentFromItem");
ProcObjectTimer(_Char,"AS_TalentItemBLReset",500);
CharacterRemoveTalent(_Char,_Talent);

IF
ObjectLeftCombat((CHARACTERGUID)_Char,_)
AND
DB_AS_BaseTalentFromItem(_Char,_Talent)
THEN
ObjectSetFlag(_Char,"AS_Blacklist_TalentFromItem");
ProcObjectTimer(_Char,"AS_TalentItemBLReset",1000);


IF
ObjectEnteredCombat((CHARACTERGUID)_Char,_)
THEN
ObjectSetFlag(_Char,"AS_Blacklist_DontRemoveTalents");
ProcObjectTimerCancel(_Char,"AS_ResetTalentBlacklist");
ProcObjectTimer(_Char,"AS_ResetTalentBlacklist",2000);

IF
ObjectLeftCombat(_Char,_)
THEN
ProcObjectTimerCancel(_Char,"AS_ResetTalentBlacklist");
ProcObjectTimer(_Char,"AS_ResetTalentBlacklist",1000);

PROC
ProcObjectTimerFinished((CHARACTERGUID)_Char,"AS_ResetTalentBlacklist")
AND
CharacterIsInCombat(_Char,0)
THEN
ObjectClearFlag(_Char,"AS_Blacklist_DontRemoveTalents");

IF
ObjectEnteredCombat((CHARACTERGUID)_Char,_)
THEN
SetStoryEvent(_Char,"AS_LearnCombatTalents");

IF
StoryEvent((CHARACTERGUID)_Char,"AS_LearnCombatTalents")
THEN
CharacterAddTalent(_Char,"QuickStep");
CharacterAddTalent(_Char,"ViolentMagic");
CharacterAddTalent(_Char,"AttackOfOpportunity");
ObjectSetFlag(_Char,"AS_BlacklistTalentPoint");
ProcObjectTimer(_Char,"AS_RemoveBlacklistTalentPoint",700);

PROC
ProcObjectTimerFinished(_Char,"AS_RemoveBlacklistTalentPoint")
THEN
ObjectClearFlag(_Char,"AS_BlacklistTalentPoint");


// Don't remove these talents from NPCs - or they'll never come back again!
// I have no idea why this is. But for now, a CharacterIsPlayer check will do the trick.
IF
ObjectLeftCombat((CHARACTERGUID)_Char,_)
AND
CharacterIsPlayer(_Char,1)
THEN
CharacterRemoveTalent(_Char,"QuickStep");
CharacterRemoveTalent(_Char,"ViolentMagic");
CharacterRemoveTalent(_Char,"AttackOfOpportunity");

/*
IF
CharacterStartAttackPosition(_,_,_,_,_Char)
AND
ObjectGetFlag(_Char,"HasTalent",1)
THEN
CharacterStatusText(_Char,"The flag is ACTIVE.");

IF
CharacterStartAttackPosition(_,_,_,_,_Char)
AND
ObjectGetFlag(_Char,"HasTalent",0)
THEN
CharacterStatusText(_Char,"Flag not active.");
*/
EXITSECTION

ENDEXITSECTION
